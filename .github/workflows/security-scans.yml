name: Anchore-Grype Security Scans

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to scan'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - development
      severity-cutoff:
        description: 'Minimum severity level to report'
        required: false
        default: 'high'
        type: choice
        options:
          - negligible
          - low
          - medium
          - high
          - critical
      fail-build:
        description: 'Fail build on vulnerabilities'
        required: false
        default: true
        type: boolean
  schedule:
    # Run this against the main branch every Monday at 5:30 AM
    - cron: "30 5 * * 2"

permissions: write-all

env:
  JDK: 21

jobs:
  scan:
    runs-on: ubuntu-latest
    # Checkout the main/release branch
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ env.JDK }}

      - name: Setup Environment Variables For Build Process
        id: current_version
        run: |
          # Read Version from gradle.properties
          echo "VERSION=`grep '^version=' gradle.properties | cut -d'=' -f2`" >> $GITHUB_ENV

          # Set branch from input or detect from ref
          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then
            if [ "$GITHUB_REF" == "refs/heads/development" ]; then
              BRANCH="development"
            else
              BRANCH="main"
            fi
          fi
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "Using branch: $BRANCH"

      - name: Build it!
        run: ./gradlew clean jar

      - name: Scan generated packages
        uses: anchore/scan-action@v6
        id: securityscan
        with:
          path: "./build/libs"
          output-format: sarif
          severity-cutoff: ${{ github.event.inputs.severity-cutoff || 'high' }}
          by-cve: "true"
          fail-build: ${{ github.event.inputs.fail-build != 'false' }}

      - name: Upload Anchore Report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.securityscan.outputs.sarif }}
          category: "BoxLang-Runtime-${{ env.BRANCH }}"
